{% extends "layout.html" %}
{% load static %}
{% load dash_extras %}
{% load reports_extras %}
{% block title %}Распределение вариантов ответов{% endblock %}

{% block style %}
    <link href="{% static 'dashboards/css/ter_admins_dash.css' %}" rel="stylesheet">
    <style>
        .chart-container {
            width: 100%;
            margin-bottom: 30px;
        }
        
        .section-header {
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
            color: #003366;
        }
        
        .field-header {
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 500;
            color: #444;
            background-color: #f5f5f5;
            padding: 10px 15px;
            border-radius: 6px;
            border-left: 4px solid #003366;
        }
        
        .field-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .field-header p {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            color: #666;
        }
        
        .field-charts {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .chart-card {
            flex: 1 1 calc(50% - 20px);
            min-width: 400px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            background-color: white;
            transition: box-shadow 0.3s ease;
        }
        
        .chart-card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            color: #003366;
        }
        
        .chart-subtitle {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .date-info {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            color: #555;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
        }
        
        .legend {
            text-align: center;
            margin-bottom: 25px;
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        
        .legend span {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .red-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #FFC7CE;
            display: inline-block;
            margin-right: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .yellow-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #FFEB9C;
            display: inline-block;
            margin-right: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .green-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #C6EFCE;
            display: inline-block;
            margin-right: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .report-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-top: 20px;
        }
        
        .report-container h1 {
            text-align: center;
            color: #003366;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .filter {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }
        
        .filter-buttons {
            width: 100%;
            display: flex;
            justify-content: space-between;
            flex-direction: row-reverse;
            margin-top: 15px;
            margin-bottom: 30px;
        }
        
        .filter-buttons-right {
            display: flex;
            gap: 10px;
        }
        
        .btn-outline-primary {
            border-color: #003366;
            color: #003366;
        }
        
        .btn-outline-primary:hover {
            background-color: #003366;
            color: white;
        }
        
        .btn-primary {
            background-color: #003366;
            border-color: #003366;
        }
        
        .btn-primary:hover {
            background-color: #002244;
            border-color: #002244;
        }
        
        /* Стили для адаптивности на мобильных устройствах */
        @media (max-width: 768px) {
            .field-charts {
                flex-direction: column;
            }
            
            .chart-card {
                min-width: 100%;
            }
            
            .filter-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-buttons-right {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100% !important;
            }
        }
    </style>
    <!-- Подключаем библиотеку для построения графиков Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block body %}
    <form action="{% url 'answers_distribution_report' %}" method="post">
        {% csrf_token %}
        <h2>Фильтр</h2>
        <div class="filter">
            <div class="form mb-3">
                <label for="YearFilter">Год</label>
                <select class="selectpicker form-control" title="Выберите год" name="year" id="YearFilter" data-width="100%" data-container="body" required>
                    {% for year in filter.years %}
                        {% if forloop.first %}
                            <option value="{{ year }}" {% if year == filter.year %}selected{% endif %}>{{ year }}</option>
                        {% else %}
                            <option value="{{ year }}" {% if year == filter.year %}selected{% endif %}>{{ year }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="form mb-3">
                <label for="TerAdminFilter">Территориальные управления/Департаменты образования</label>
                <select class="selectpicker form-control" title="Выберите ТУ/ДО" name="ter_admin" id="TerAdminFilter" data-width="100%" data-container="body" data-live-search="true">
                    <option value="">Все ТУ/ДО</option>
                    {% for ter_admin in filter.ter_admins %}
                        <option value="{{ ter_admin.id }}" {% if ter_admin.id|stringformat:"i" == filter.ter_admin %}selected{% endif %}>{{ ter_admin }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form mb-3">
                <label for="ClosterFilter">Кластер</label>
                <select class="selectpicker form-control" title="Выберите кластер" name="closter" id="ClosterFilter" data-width="100%" data-container="body" data-live-search="true">
                    <option value="">Все кластеры</option>
                    {% for closter in filter.closters %}
                        <option value="{{ closter.id }}" {% if closter.id|stringformat:"i" == filter.closter %}selected{% endif %}>{{ closter }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form mb-3">
                <label for="EdLevelFilter">Уровень образования</label>
                <select class="selectpicker form-control" title="Выберите уровень образования" name="ed_level" id="EdLevelFilter" data-width="100%" data-container="body">
                    <option value="">Все уровни</option>
                    {% for key, name in filter.school_levels.items %}
                        <option value="{{ key }}" {% if key == filter.ed_level %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="filter-buttons">
            <div class="filter-buttons-right">
                <button name="download" class="btn btn-outline-primary" type="submit">Скачать в Excel</button>
                <button name="filter" class="btn btn-outline-primary" type="submit">Фильтровать</button>
            </div>
            <a href="{% url 'answers_distribution_report' %}" class="btn btn-primary">Сбросить</a>
        </div>
    </form>
    
    <div class="report-container">
        <h1>Распределение вариантов ответов по показателям</h1>
        
        <div class="date-info">
            <p>Данные мониторинга за {{ stats.last_monitoring_date }} год</p>
        </div>
        
        <div class="legend">
            <span><span class="red-dot"></span> Красная зона</span>
            <span><span class="yellow-dot"></span> Желтая зона</span>
            <span><span class="green-dot"></span> Зеленая зона</span>
        </div>
        
        {% for section in sections %}
            <div class="section-header">
                <h2>{{ section.number }}. {{ section.name }}</h2>
            </div>
            
            {% for field in section.fields.all|dictsort_fields %}
                <div class="field-header">
                    <h3>{{ section.number }}.{{ field.number }}. {{ field.name }}</h3>
                    <p>Всего школ: {{ stats.field_school_counts|get_item:field.id }}</p>
                </div>
                
                <div class="field-charts">
                    <!-- График для общей статистики -->
                    <div class="chart-card">
                        <div class="chart-title">Общее распределение ответов</div>
                        <div class="chart-subtitle">Процентное соотношение вариантов ответов</div>
                        <canvas id="chart-overall-{{ section.id }}-{{ field.id }}"></canvas>
                    </div>
                    
                    <!-- График для статистики по ТУ/ДО -->
                    <div class="chart-card">
                        <div class="chart-title">Распределение ответов по ТУ/ДО</div>
                        <div class="chart-subtitle">Процентное соотношение вариантов ответов в разрезе ТУ/ДО</div>
                        <canvas id="chart-teradmin-{{ section.id }}-{{ field.id }}"></canvas>
                    </div>
                    
                    <!-- График для статистики по кластерам -->
                    <div class="chart-card">
                        <div class="chart-title">Распределение ответов по кластерам</div>
                        <div class="chart-subtitle">Процентное соотношение вариантов ответов в разрезе кластеров</div>
                        <canvas id="chart-closter-{{ section.id }}-{{ field.id }}"></canvas>
                    </div>
                    
                    <!-- График для статистики по уровням образования -->
                    <div class="chart-card">
                        <div class="chart-title">Распределение ответов по уровням образования</div>
                        <div class="chart-subtitle">Процентное соотношение вариантов ответов в разрезе уровней образования</div>
                        <canvas id="chart-edlevel-{{ section.id }}-{{ field.id }}"></canvas>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    
    <script>
        // Функция для инициализации графиков после загрузки страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Данные для графиков
            const statsData = {{ stats|safe_json }};
            
            // Цвета для зон
            const zoneColors = {
                'R': '#FFC7CE',
                'Y': '#FFEB9C',
                'G': '#C6EFCE'
            };
            
            // Обработка данных и создание графиков для каждого поля
            {% for section in sections %}
                {% for field in section.fields.all|dictsort_fields %}
                    // Данные для общей статистики
                    const overallData = statsData.overall_stats['{{ section.id }}']['{{ field.id }}'];
                    if (overallData) {
                        const overallLabels = [];
                        const overallValues = [];
                        const overallColors = [];
                        
                        for (const [optionId, optionData] of Object.entries(overallData)) {
                            overallLabels.push(optionData.option_name);
                            overallValues.push(optionData.percentage);
                            overallColors.push(zoneColors[optionData.zone] || '#cccccc');
                        }
                        
                        // Создаем график для общей статистики
                        const overallCtx = document.getElementById('chart-overall-{{ section.id }}-{{ field.id }}').getContext('2d');
                        new Chart(overallCtx, {
                            type: 'pie',
                            data: {
                                labels: overallLabels,
                                datasets: [{
                                    data: overallValues,
                                    backgroundColor: overallColors,
                                    borderColor: '#ffffff',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            font: {
                                                size: 12
                                            }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.raw || 0;
                                                return `${label}: ${value}%`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                    // Данные для статистики по ТУ/ДО
                    const terAdminCtx = document.getElementById('chart-teradmin-{{ section.id }}-{{ field.id }}').getContext('2d');
                    const terAdminStats = statsData.ter_admin_stats;
                    
                    // Собираем данные по ТУ/ДО
                    const terAdminLabels = [];
                    const terAdminDatasets = [];
                    const terAdminOptions = new Set();
                    
                    // Собираем все варианты ответов для этого поля
                    for (const [terAdminId, terAdminData] of Object.entries(terAdminStats)) {
                        if (terAdminData['{{ section.id }}'] && terAdminData['{{ section.id }}']['{{ field.id }}']) {
                            for (const [optionId, optionData] of Object.entries(terAdminData['{{ section.id }}']['{{ field.id }}'])) {
                                terAdminOptions.add(optionId);
                            }
                        }
                    }
                    
                    // Преобразуем Set в массив для дальнейшей обработки
                    const terAdminOptionsArray = Array.from(terAdminOptions);
                    
                    // Создаем наборы данных для каждого варианта ответа
                    for (const optionId of terAdminOptionsArray) {
                        const dataset = {
                            label: '',
                            data: [],
                            backgroundColor: '',
                            borderColor: '#ffffff',
                            borderWidth: 1
                        };
                        
                        for (const [terAdminId, terAdminData] of Object.entries(terAdminStats)) {
                            if (!terAdminLabels.includes(terAdminId)) {
                                terAdminLabels.push(terAdminId);
                            }
                            
                            if (terAdminData['{{ section.id }}'] && 
                                terAdminData['{{ section.id }}']['{{ field.id }}'] && 
                                terAdminData['{{ section.id }}']['{{ field.id }}'][optionId]) {
                                
                                const optionData = terAdminData['{{ section.id }}']['{{ field.id }}'][optionId];
                                dataset.label = optionData.option_name;
                                dataset.backgroundColor = zoneColors[optionData.zone] || '#cccccc';
                                dataset.data.push(optionData.percentage);
                            } else {
                                dataset.data.push(0);
                            }
                        }
                        
                        terAdminDatasets.push(dataset);
                    }
                    
                    // Создаем график для статистики по ТУ/ДО
                    new Chart(terAdminCtx, {
                        type: 'bar',
                        data: {
                            labels: terAdminLabels,
                            datasets: terAdminDatasets
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: {
                                    stacked: true
                                },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    max: 100
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.dataset.label || '';
                                            const value = context.raw || 0;
                                            return `${label}: ${value}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Данные для статистики по кластерам
                    const closterCtx = document.getElementById('chart-closter-{{ section.id }}-{{ field.id }}').getContext('2d');
                    const closterStats = statsData.closter_stats;
                    
                    // Собираем данные по кластерам
                    const closterLabels = [];
                    const closterDatasets = [];
                    const closterOptions = new Set();
                    
                    // Собираем все варианты ответов для этого поля
                    for (const [closterId, closterData] of Object.entries(closterStats)) {
                        if (closterData['{{ section.id }}'] && closterData['{{ section.id }}']['{{ field.id }}']) {
                            for (const [optionId, optionData] of Object.entries(closterData['{{ section.id }}']['{{ field.id }}'])) {
                                closterOptions.add(optionId);
                            }
                        }
                    }
                    
                    // Преобразуем Set в массив для дальнейшей обработки
                    const closterOptionsArray = Array.from(closterOptions);
                    
                    // Создаем наборы данных для каждого варианта ответа
                    for (const optionId of closterOptionsArray) {
                        const dataset = {
                            label: '',
                            data: [],
                            backgroundColor: '',
                            borderColor: '#ffffff',
                            borderWidth: 1
                        };
                        
                        for (const [closterId, closterData] of Object.entries(closterStats)) {
                            if (!closterLabels.includes(closterId)) {
                                closterLabels.push(closterId);
                            }
                            
                            if (closterData['{{ section.id }}'] && 
                                closterData['{{ section.id }}']['{{ field.id }}'] && 
                                closterData['{{ section.id }}']['{{ field.id }}'][optionId]) {
                                
                                const optionData = closterData['{{ section.id }}']['{{ field.id }}'][optionId];
                                dataset.label = optionData.option_name;
                                dataset.backgroundColor = zoneColors[optionData.zone] || '#cccccc';
                                dataset.data.push(optionData.percentage);
                            } else {
                                dataset.data.push(0);
                            }
                        }
                        
                        closterDatasets.push(dataset);
                    }
                    
                    // Создаем график для статистики по кластерам
                    new Chart(closterCtx, {
                        type: 'bar',
                        data: {
                            labels: closterLabels,
                            datasets: closterDatasets
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: {
                                    stacked: true
                                },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    max: 100
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.dataset.label || '';
                                            const value = context.raw || 0;
                                            return `${label}: ${value}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Данные для статистики по уровням образования
                    const edLevelCtx = document.getElementById('chart-edlevel-{{ section.id }}-{{ field.id }}').getContext('2d');
                    const edLevelStats = statsData.ed_level_stats;
                    
                    // Собираем данные по уровням образования
                    const edLevelLabels = [];
                    const edLevelDatasets = [];
                    const edLevelOptions = new Set();
                    
                    // Собираем все варианты ответов для этого поля
                    for (const [edLevel, edLevelData] of Object.entries(edLevelStats)) {
                        if (edLevelData['{{ section.id }}'] && edLevelData['{{ section.id }}']['{{ field.id }}']) {
                            for (const [optionId, optionData] of Object.entries(edLevelData['{{ section.id }}']['{{ field.id }}'])) {
                                edLevelOptions.add(optionId);
                            }
                        }
                    }
                    
                    // Преобразуем Set в массив для дальнейшей обработки
                    const edLevelOptionsArray = Array.from(edLevelOptions);
                    
                    // Создаем наборы данных для каждого варианта ответа
                    for (const optionId of edLevelOptionsArray) {
                        const dataset = {
                            label: '',
                            data: [],
                            backgroundColor: '',
                            borderColor: '#ffffff',
                            borderWidth: 1
                        };
                        
                        for (const [edLevel, edLevelData] of Object.entries(edLevelStats)) {
                            if (!edLevelLabels.includes(edLevel)) {
                                edLevelLabels.push(edLevel);
                            }
                            
                            if (edLevelData['{{ section.id }}'] && 
                                edLevelData['{{ section.id }}']['{{ field.id }}'] && 
                                edLevelData['{{ section.id }}']['{{ field.id }}'][optionId]) {
                                
                                const optionData = edLevelData['{{ section.id }}']['{{ field.id }}'][optionId];
                                dataset.label = optionData.option_name;
                                dataset.backgroundColor = zoneColors[optionData.zone] || '#cccccc';
                                dataset.data.push(optionData.percentage);
                            } else {
                                dataset.data.push(0);
                            }
                        }
                        
                        edLevelDatasets.push(dataset);
                    }
                    
                    // Создаем график для статистики по уровням образования
                    new Chart(edLevelCtx, {
                        type: 'bar',
                        data: {
                            labels: edLevelLabels,
                            datasets: edLevelDatasets
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: {
                                    stacked: true
                                },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    max: 100
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.dataset.label || '';
                                            const value = context.raw || 0;
                                            return `${label}: ${value}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                {% endfor %}
            {% endfor %}
        });
    </script>
{% endblock %} 