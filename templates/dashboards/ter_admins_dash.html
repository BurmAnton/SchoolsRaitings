{% extends "layout.html" %}
{% load static %}
{% load dash_extras %}
{% load reports_extras %}
{% block title %}Статистика{% endblock %}

{% block style %}
        <link href="{% static 'dashboards/css/ter_admins_dash.css' %}" rel="stylesheet">
{% endblock %}
{% block script %}
    <script src="{% static 'dashboards/js/ter_admins_reports.js' %}" rel="stylesheet"></script>
{% endblock %}

{% block body %}
    <form action="{% url 'ter_admins_dash' %}" method="post">
        <h2>Фильтр</h2>
        <div class="filter">
            <div class="form mb-3">
                <label for="YearFilter">Год</label>
                <select class="selectpicker" title="Выберите год" name="year" id="YearFilter" data-width="100%" data-container="body" required>
                    {% for year in years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form mb-3">
                <label for="TerAdminFilter">Территориальные управления/Департаменты образования</label>
                <select class="selectpicker" title="Выберите ТУ/ДО" name="ter_admins" id="TerAdminFilter" required data-width="100%" data-container="body" data-live-search="true">
                    {% for ter_admin in ter_admins %}
                        <option value="{{ ter_admin.id }}" {% if ter_admin.id|stringformat:"i"  in filter|get_item:"ter_admins" %}selected{% endif %}>{{ ter_admin }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form mb-3">
                <label for="EdLevelsFilter">Уровень образования</label>
                <select class="selectpicker" title="Выберите уровни образования" name="ed_levels" id="EdLevelsFilter" multiple data-width="100%" data-container="body" data-live-search="true">
                    {% for key, name in ed_levels.items %}
                        <option value="{{ key }}"  {% if key in filter|get_item:"ed_levels" %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form mb-3">
                <label for="ClosterFilter">Кластеры</label>
                <select class="selectpicker" title="Выберите кластеры" name="closters" id="ClosterFilter" multiple data-selected-text-format="static" data-width="100%" data-container="body" data-live-search="true">
                    {% for closter in closters %}
                        <option value="{{ closter.id }}" {% if closter.id|stringformat:"i"  in filter|get_item:"closters" %}selected{% endif %}>{{ closter }}</option>
                    {% endfor %}
                </select>
            </div>
            
        </div>
        <div style="width: 100%; display: flex; justify-content: space-between;flex-direction: row-reverse; margin-top: 10px;">
            <button style="width: 250px" name="filter" class="btn btn-sm btn-outline-primary" type="submit">Фильтровать</button>
            {% if filter is not None %}<a style="width: 150px" href="{% url 'ter_admins_dash' %}" class="btn btn-sm btn-primary">Сбросить</a>{% endif %}
        </div>
    </form>
    <div id="ReportSchools">
        <h1>Показатели рейтинга общеобразовательных организаций Самарской области</h1>
        <div class="outer-container">
            <div class="table-container">
                <table class="table">
                    <tr>
                        <th scope="row"class="sticky-top">Школа</th>
                        <th scope="row" class="sticky-top ">ТУ/ДО</th>
                        <th scope="row" class="sticky-top">Уровень образования</th>
                        <th scope="row" class="sticky-top" style="text-align: center;">Итого</th>
                        {% for section in sections %}
                            <th scope="row" style="text-align: center;" class="section-hdr sticky-top">
                                {{section}}
                            </th>
                        {% endfor %}
                    </tr>
                    {% for s_report in schools_reports %}
                        <tr>
                            <td scope="row" class="sticky-row"><div style="display: flex;gap: 5px; align-items: center;"><div id="report-zone" style="background-color: {% if s_report.report.is_counting %}{{s_report.zone|get_color}}{% endif %}; width: 15px; height: 15px; border-radius: 15px"></div><div>{{ s_report.school }}</div></div></td>
                            <td scope="row">{{ s_report.school.ter_admin }}</td>
                            <td scope="row">{{ s_report.school.get_ed_level_display }}</td>
                            <td scope="row" style="text-align: center; vertical-align: middle;">
                                    <div>{{ s_report.points|format_point }}</div>
                            </td>
                            {% for section in sections.all %}
                                <td scope="row" style="text-align: center; vertical-align: middle;">
                                    <div style="display: flex;gap: 5px; align-items: center; justify-content: center;">
                                        <div class="section-zone" style="background-color: {{s_report|get_section_color:section}}; width: 15px; height: 15px; border-radius: 15px"></div>
                                        <div>{{ s_report|get_section_points:section }}</div>
                                    </div>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    <tr>
                        <td></td>
                        <td></td>
                        <td scope="row" colspan="1" style="text-align: left;" class="sticky-row"><b>Итого</b></td>
                        <td scope="row" style="text-align: center;"><b>{{ schools_reports|get_point_sum }}</b></td>
                        {% for section in sections.all %}
                            <td scope="row" style="text-align: center;"><b>{{ schools_reports|get_point_sum_section:section }}</b></td>
                        {% endfor %}
                    </tr>
                </table>
            </div>
        </div>
    </div>

    {% for section in sections %}
        <div class="section">
            <h2>{{ section }}</h2>
            <div class="outer-container">
                <div class="table-container">
                    <table class="table">
                        <tr>
                            <th scope="row">Школа</th>
                            <th scope="row">ТУ/ДО</th>
                            <th scope="row">Уровень образования</th>
                            <th scope="row">Итого</th>
                            {% for field in section.fields.all %}
                                <th  class="section-hdr sticky-top" scope="row" style="text-align: center;">{{ section.number }}.{{ field.number }}. {{ field.name }}</th>
                            {% endfor %}
                        </tr>
                        {% for s_report in schools_reports %}
                            <tr>
                                <td scope="row" class="sticky-row"><div style="display: flex;gap: 5px; align-items: center;"><div class="section-zone" style="background-color: {{s_report|get_section_color:section}}; width: 15px; height: 15px; border-radius: 15px"></div><div>{{ s_report.school }}</div></div></td>
                                <td scope="row">{{ s_report.school.ter_admin }}</td>
                                <td scope="row">{{ s_report.school.get_ed_level_display }}</td>
                                <td scope="row" style="text-align: center;">{{ s_report|get_section_points:section }}</td>
                                {% for field in section.fields.all %}
                                    <td scope="row" style="text-align: center;">
                                        <div style=" {% if s_report.report.is_counting %}display: flex; justify-content: center; align-items: center; height: 100%; gap: 5px;{% endif%}"><div class="field-zone field-zone{{field.id}}" id="zone-field{{field.id}}" style="background-color: {{s_report.answers.all|get_answer:field}}; width: 15px; height: 15px; border-radius: 15px"></div><div>{{ s_report|get_field_points:field }}</div></div>
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        <tr>
                            <td scope="row" colspan="3" style="text-align: center;"><b>Итого</b></td>
                            <td scope="row" style="text-align: center;"><b>{{ schools_reports|get_point_sum_section:section }}</b></td>
                            {% for field in section.fields.all %}
                                <td scope="row" style="text-align: center;"><b>{{ schools_reports|get_point_sum_field:field }}</b></td>
                            {% endfor %}
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    {% endfor %}
{% endblock %}