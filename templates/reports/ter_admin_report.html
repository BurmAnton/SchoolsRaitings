{% extends "layout.html" %}
{% load static %}
{% load reports_extras %}
{% block title %}Отчёт{% endblock %}

{% block style %}
    <link href="{% static 'reports/css/report.css' %}" rel="stylesheet">
{% endblock %}
{% block script %}
    <script src="{% static 'reports/js/report.js' %}" rel="stylesheet"></script>
{% endblock %}

{% block body %}

    <div class="modal fade" id="SaveModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Отправка отчёта</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div style="font-size: 18px;" class="modal-body">
                    <p>При нажатии кнопки "Отправить в МинОбр", отчёт будет отправлен в министертсво образования.</p>
                    <p style="margin-bottom: 0;"><b>Внимание!!!</b> Вы <b>не сможете</b> отменить это действие. В случае отправки Вы <b>не сможете</b> изменить отчёт.</p>

                </div>
                <div class="modal-footer">
                    <form method="post" action="{% url 'ter_admin_report' ter_admin.id report.id %}">
                        <button style="width: 250px" name="send-report" class="btn btn-success send-report" type="submit">Отправить в МинОбр</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <h1>{{ report.report }}</h1>
    <h2 id="report-school"><span style="font-weight: 500;padding-right: 5px;">Учебное заведение:</span> {{ school }}</h2>
    <h2 id="report-status"><span style="font-weight: 500;padding-right: 5px;">Статус:</span> {{ report.get_status_display }}</h2>
    <h2 id="report-points-zone"><div id="report-zone" style="background-color: {% if report.report.is_counting %}{{report.zone|get_color}}{% endif %}; width: 15px; height: 15px; border-radius: 15px"></div><span style="font-weight: 500; padding-right: 5px;">Баллы:</span> <span id="report-points">{{ report.points|format_point }}</span>/{{ report.report.points|format_point }} </h2>
    
    {% if message == 'SendToMinObr' %}
        <div class="alert alert-success" role="alert" style="margin-top: 10px; text-align: center;">
            <div>Отчёт успешно отправлен на проверку в министертсво образования. Следите за изменением статус отчёта в Вашем личном кабинете.</div>
        </div>
    {% endif %}
    <div class="control-panel">
        <a href="{% url 'ter_admin_reports' request.user.id %}" style="width: 250px" class="btn btn-outline-primary" type="submit">Вернуться к отчётам</a>
        {% if report.status == 'A' %}
            <button type="button" id='send-button' class="btn {% if report.is_ready %}btn-success{% else %}btn-secondary disabled{% endif %}" data-bs-toggle="modal" data-bs-target="#SaveModal">
                Отправить в МинОбр
            </button>
        {% endif %}
    </div>
   {% for section in report.report.sections.all %}
        <div class="section {% if current_section == section.id %}current-section{% endif %} {% if forloop.first %}first{% elif forloop.last %}last{% endif %}">
            <h2><div class="section-zone" style="background-color: {{report|get_section_color:section}}; width: 15px; height: 15px; border-radius: 15px"></div>{{ section }}</h2>
            {% if section.note is not None and section.note != "" %}
                <div class="alert alert-primary note  d-flex align-items-center" role="alert">
                    <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Info:"><use xlink:href="#info-fill"/></svg>
                    <div >
                        {{ section.note |safe  }}
                    </div>
                </div>
            {% endif %}
            <table class="table section-table">
                <tr class="tr-section sticky-top">
                    <th colspan="2">Показатели/критерии</th>
                    <th class="center th-points">Баллы</th>
                    <th class="center th-points">Источники данных</th>
                    {% comment %} <th class="center th-points">Макс.</th> {% endcomment %}
                </tr>
            {%for field in section.fields.all %}
                <tr class="question {% if field.answer_type == 'BL' %}question-bl{% endif %}"> 
                    <td style="width: 10px;"><div class="question-zone question-zone{{field.id}}" data-field="{{field.id}}" style="background-color: {{answers|get_answer:field}}; width: 15px; height: 15px; border-radius: 15px"></div></td>
                    <td scope="row">
                        {% if field.answer_type == 'LST' %}
                            <div class="mb-3 field filed-select">
                                <label for="{{ question.id }}">{{ section.number }}.{{ field.number }}. {{ field.name }}</label>
                                <select class="selectpicker" data-width="100%" data-live-search="true" id="{{ field.id }}" name="{{ field.id }}" {% if report.status != 'C'%}disabled{% endif%}>
                                    <option data-points="0" value="">Не заполнено</option>
                                    {% for option in field.options.all %}
                                        <option value="{{ option.id }}"  data-points="{{option.points}}" {% if answers|find_answer:field == option.id %}selected{% endif %}>
                                            {{ option.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if answers|is_answer_changed_by_mo:field %}<br><span style="color: red; font-size: 12px;">*Данные изменены МинОбр</span>{% endif %}
                            </div>
                        {% elif field.answer_type == 'NMBR' or field.answer_type == 'PRC' %}
                            <label for="{{ field.id }}">{{ section.number }}.{{ field.number }}. {{ field.name }}</label>
                            <div class="mb-3 input-group field">
                                {% if field.answer_type == 'PRC' %}
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">%</span>
                                    </div>
                                {% endif %}
                                <input type="number" maxlength="4" class="form-control number-input" id="{{ field.id }}" data-points="{{ answers|get_points:field }}" value="{{answers|find_answer:field}}"  name="{{ field.id }}" placeholder="" {% if report.status != 'C'%}disabled{% endif%}>
                            </div>
                            {% if answers|is_answer_changed_by_mo:field %}<br><span style="color: red; font-size: 12px;">*Данные изменены МинОбр</span>{% endif %}
                        {% elif field.answer_type == 'BL' %}
                            <div class="form-check field">
                                <input class="form-check-input" type="checkbox" data-points="{{field.bool_points}}" name="{{ field.id }}" id="{{ field.id }}" {% if answers|find_answer:field %}checked{% endif %} {% if report.status != 'C'%}disabled{% endif%}>
                                <label class="form-check-label" for="{{ field.id }}">{{ section.number }}.{{ field.number }}. {{ field.name }}</label>
                            </div>
                            {% if answers|is_answer_changed_by_mo:field %}<br><span style="color: red; font-size: 12px;">*Данные изменены МинОбр</span>{% endif %}
                        {% endif %}
                        {% if field.note is not None and field.note != "" %}
                            <div class="alert alert-primary note  d-flex align-items-center" role="alert">
                                <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Info:"><use xlink:href="#info-fill"/></svg>
                                <div >
                                    {{ field.note |safe  }}
                                </div>
                            </div>
                        {% endif %}
                    </td>
                    <td scope="row" class="question-points" id="points_{{ field.id }}">{{ answers|get_points:field }}</td>
                    <td scope="row" class="attachment-section" style="width: 300px;">
                        {% comment %} {{ field.attachment.name }} {% endcomment %}
                        {% if field.attachment_type == 'LNK' %}
                            <div class="mb-3 field">
                                {% if field.attachment_name is not None and field.attachment_name != "" %}
                                    <label for="Att{{ field.id }}_{{field.id}}">{{ field.attachment_name }}</label> 
                                {% endif %}
                                <input type="link" class="form-control" id="Att{{ field.id }}" name="{{field.id}}" placeholder="Ссылка" >
                            </div>
                        {% elif field.attachment_type == 'DC' %}
                            <div class="mb-3">
                                {% if field.attachment_name is not None and field.attachment_name != "" %}
                                    <label for="Att{{ field.id }}_{{field.id}}" style="margin: 0px;">{{ field.attachment_name }}</label> 
                                {% endif %}
                                <div id ="alert{{ field.id }}_{{field.id}}" class="alert alert-success alert-dismissible fade show" style="width: 300px;" role="alert">
                                    Документ загружен успешно!
                                </div>
                                <div class="get-attachment">
                                    <a class='attachment{{field.id}}' {% if answers|get_file_link:field != None %}href="{{ answers|get_file_link:field }}"{% else %}style="display: none;"{% endif %} target="_blank">
                                        <button class="btn btn-outline-success btn-sm" style="width: 100%;margin-bottom: 5px;">Скачать прикреплённый файл</button>
                                    </a>
                                    <input type="file" name="{{field.id}}" class="form-control " id="Att{{field.id}}">
                                </div>
                            </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                <tr class="tr-section">
                    <th colspan="2">Всего</th>
                    <th class="center section-points"></th>
                    <th></th>
                    {% comment %} <th class="center section-points-max"></th> {% endcomment %}
                </tr>
            </table>
        </div>
   {% endfor %}
    {% comment %} {% if attachments.count != 0 %}
        <div class="section attachment-section {% if current_section == -1 %}current-section{% endif %} last">
            <h2>Вложения к отчёту</h2>
            <div class="attachments-inputs">
                {% for attachment in attachments %}
                    {% if attachment.attachment_type == 'LNK' %}
                        <div class="mb-3 field">
                            <label for="Att{{ attachment.id }}">{{attachment.name}}</label>
                            <input type="link" class="form-control" id="Att{{ attachment.id }}" name="{{attachment.id}}" placeholder="{{attachment.name}}" {% if report.status != 'A'%}disabled{% endif%}>
                        </div>
                    {% elif attachment.attachment_type == 'DC' %}
                        <div class="mb-3">
                            <label for="Att{{attachment.id}}">{{ attachment.name }}</label> 
                            <div id ="alert{{attachment.id}}" class="alert alert-success alert-dismissible fade show" role="alert">
                                Документ загружен успешно!
                            </div>
                            <div class="get-attachment">
                                <input type="file" name="{{attachment.id}}" class="form-control" id="Att{{attachment.id}}" {% if report.status != 'A'%}disabled{% endif%}>
                                <a {% if attachment|get_file_link != None %}href="{{ attachment|get_file_link }}"{% else %}style="display: none;"{% endif %} target="_blank">
                                    <button class="btn btn-outline-success">Скачать прикреплённый файл</button>
                                </a>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    {% endif %} {% endcomment %}
    <div class="sections-panel">
        <button style="width: 150px" id="btn-back" class="btn btn-outline-primary" type="submit">Назад</button>
        <button style="width: 150px" id="btn-forward" class="btn btn-primary" type="submit">Вперёд</button>
    </div>
{% endblock %}