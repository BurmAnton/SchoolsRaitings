{% extends "layout.html" %}
{% load static %}
{% load reports_extras %}
{% block title %}Отчёт{% endblock %}

{% block style %}
    <link href="{% static 'reports/css/report.css' %}" rel="stylesheet">
{% endblock %}
{% block script %}
    <script src="{% static 'reports/js/report.js' %}" rel="stylesheet"></script>
{% endblock %}

{% block body %}

    <div class="modal fade" id="SaveModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Отправка отчёта</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div style="font-size: 18px;" class="modal-body">
                    <p>При нажатии кнопки "Отправить в МинОбр", отчёт будет отправлен в министертсво образования.</p>
                    <p style="margin-bottom: 0;"><b>Внимание!!!</b> Вы <b>не сможете</b> отменить это действие. В случае отправки Вы <b>не сможете</b> изменить отчёт.</p>

                </div>
                <div class="modal-footer">
                    <form method="post" action="{% url 'ter_admin_report' ter_admin.id report.id %}">
                        <button style="width: 250px" name="send-report" class="btn {% if report.is_ready %}btn-success{% else %}btn-secondary disabled{% endif %} send-report" type="submit">Отправить в МинОбр</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <h1>{{ report.report }}</h1>
    <h2 id="report-school"><span style="font-weight: 500;">Учебное заведение:</span> {{ school }}</h2>
    <h2 id="report-status"><span style="font-weight: 500;">Статус:</span> {{ report.get_status_display }}</h2>
    <h2 id="report-points-zone"><span style="font-weight: 500;">Баллы:</span> <span id="report-points">{{ report.points|format_point }}</span>/{{ report.report.points|format_point }} (<span id="report-zone">{{ report.zone.get_zone_display }}</span> зона)</h2>
    
    {% if message == 'SendToMinObr' %}
        <div class="alert alert-success" role="alert" style="margin-top: 10px; text-align: center;">
            <div>Отчёт успешно отправлен на проверку в министертсво образования. Следите за изменением статус отчёта в Вашем личном кабинете.</div>
        </div>
    {% endif %}
    <div class="control-panel">
        <a href="{% url 'ter_admin_reports' request.user.id %}" style="width: 250px" class="btn btn-outline-primary" type="submit">Вернуться к отчётам</a>
        {% if report.status == 'A' %}
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#SaveModal">
                Отправить в МинОбр
            </button>
        {% endif %}
    </div>
   {% for section in report.report.sections.all %}
        <div class="section {% if current_section == section.id %}current-section{% endif %} {% if forloop.first %}first{% elif forloop.last and attachments.count == 0 %}last{% endif %}">
            <h2>{{ section }}</h2>
            {% if section.note is not None and question.note != "" %}
                <div class="alert alert-primary note  d-flex align-items-center" role="alert">
                    <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Info:"><use xlink:href="#info-fill"/></svg>
                    <div >
                        {{ section.note |safe  }}
                    </div>
                </div>
            {% endif %}
            <table class="table section-table">
                <tr class="tr-section sticky-top">
                    <th>Показатели/критерии</th>
                    <th class="center th-points">Баллы</th>
                    <th class="center th-points">Макс.</th>
                </tr>
            {%for field in section.fields.all %}
                    <tr class="tr-field">
                        <th>
                            <div>{{ field }}</div>
                            {% if field.note is not None and field.note != "" %}
                                <div class="alert alert-primary note  d-flex align-items-center" role="alert">
                                    <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Info:"><use xlink:href="#info-fill"/></svg>
                                    <div>{{ field.note |safe  }}</div>
                                </div>
                            {% endif %}
                        </th>
                        <th colspan="2"></th>
                    </tr>             
                    {%for question in field.questions.all %}
                        <tr class="question">
                            <td scope="row">
                                {% if question.answer_type == 'LST' %}
                                    <div class="form-floating mb-3 field filed-select">
                                        <select class="selectpicker" data-width="100%" data-live-search="true" id="{{ question.id }}" name="{{ question.id }}" {% if report.status != 'A'%}disabled{% endif%}>
                                            <option data-points="0" value="">Не заполнено</option>
                                            {% for option in question.options.all %}
                                                <option value="{{ option.id }}"  data-points="{{option.points}}" {% if answers|find_answer:question == option.id %}selected{% endif %}>
                                                    {{ option.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <label for="{{ question.id }}">{{question.name}}</label>
                                        {% if answers|is_answer_changed_by_mo:question %} <span style="color: red; font-size: 12px;">*Данные изменены МинОбр</span>{% endif %}
                                        {% if question.note is not None and question.note != "" %}
                                            <div class="alert alert-primary note  d-flex align-items-center" role="alert">
                                                <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Info:"><use xlink:href="#info-fill"/></svg>
                                                <div >
                                                    {{ question.note |safe  }}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% elif question.answer_type == 'NMBR' or question.answer_type == 'PRC' %}
                                    <div class="form-floating mb-3 field">
                                        <input type="number" class="form-control number-input" id="{{ question.id }}" data-points="{{ answers|get_points:question }}" value="{{answers|find_answer:question}}"  name="{{ question.id }}" placeholder="" {% if report.status != 'A'%}disabled{% endif%}>
                                        <label for="{{ question.id }}">{{question.name}}</label>
                                    </div>
                                    {% if answers|is_answer_changed_by_mo:question %} <span style="color: red; font-size: 12px;">*Данные изменены МинОбр</span>{% endif %}
                                {% elif question.answer_type == 'BL' %}
                                    <div class="form-check field">
                                        <input class="form-check-input" type="checkbox" data-points="{{question.bool_points}}" name="{{ question.id }}" id="{{ question.id }}" {% if answers|find_answer:question %}checked{% endif %} {% if report.status != 'A'%}disabled{% endif%}>
                                        <label class="form-check-label" for="{{ question.id }}">{{question.name}}</label>
                                    </div>
                                    {% if answers|is_answer_changed_by_mo:question %} <span style="color: red; font-size: 12px;">*Данные изменены МинОбр</span>{% endif %}
                                {% endif %}
                            </td>
                            <td scope="row" class="question-points" id="points_{{ question.id }}">{{ answers|get_points:question }}</td>
                            <td scope="row" class="question-points-max">{{ question|get_max_points }}</td>
                        </tr>
                    {% endfor %}
                {% endfor %}
                <tr class="tr-section">
                    <th>Всего</th>
                    <th class="center section-points"></th>
                    <th class="center section-points-max"></th>
                </tr>
            </table>
        </div>
   {% endfor %}
    {% if attachments.count != 0 %}
        <div class="section attachment-section {% if current_section == -1 %}current-section{% endif %} last">
            <h2>Вложения к отчёту</h2>
            <div class="attachments-inputs">
                {% for attachment in attachments %}
                    {% if attachment.attachment_type == 'LNK' %}
                        <div class="mb-3 field">
                            <label for="Att{{ attachment.id }}">{{attachment.name}}</label>
                            <input type="link" class="form-control" id="Att{{ attachment.id }}" name="{{attachment.id}}" placeholder="{{attachment.name}}" {% if report.status != 'A'%}disabled{% endif%}>
                        </div>
                    {% elif attachment.attachment_type == 'DC' %}
                        <div class="mb-3">
                            <label for="Att{{attachment.id}}">{{ attachment.name }}</label> 
                            <div id ="alert{{attachment.id}}" class="alert alert-success alert-dismissible fade show" role="alert">
                                Документ загружен успешно!
                            </div>
                            <div class="get-attachment">
                                <input type="file" name="{{attachment.id}}" class="form-control" id="Att{{attachment.id}}" {% if report.status != 'A'%}disabled{% endif%}>
                                <a {% if attachment|get_file_link != None %}href="{{ attachment|get_file_link }}"{% else %}style="display: none;"{% endif %} target="_blank">
                                    <button class="btn btn-outline-success">Скачать прикреплённый файл</button>
                                </a>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    {% endif %}
    <div class="sections-panel">
        <button style="width: 150px" id="btn-back" class="btn btn-outline-primary" type="submit">Назад</button>
        <button style="width: 150px" id="btn-forward" class="btn btn-primary" type="submit">Вперёд</button>
    </div>
{% endblock %}