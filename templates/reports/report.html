{% extends "layout.html" %}
{% load static %}
{% load reports_extras %}
{% block title %}Отчёты{% endblock %}

{% block style %}
    <link href="{% static 'reports/css/report.css' %}" rel="stylesheet">
{% endblock %}
{% block script %}
    <script src="{% static 'reports/js/report.js' %}" rel="stylesheet"></script>
{% endblock %}

{% block body %}

    <div class="modal fade" id="SaveModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Отправка отчёта</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div style="font-size: 18px;" class="modal-body">
                    <p>При нажатии кнопки "Отправить в ТУ/ДО", отчёт будет отправлен в {{ school.ter_admin }}.</p>
                    <p style="margin-bottom: 0;"><b>Внимание!!!</b> Вы <b>не сможете</b> отменить это действие. В случае отправки Вы <b>не сможете</b> изменить отчёт.</p>

                </div>
                <div class="modal-footer">
                    <form method="post" action="{% url 'report' report.report.id school.id %}">
                        <button style="width: 250px" name="send-report" class="btn {% if report.is_ready %}btn-success{% else %}btn-secondary disabled{% endif %} send-report" type="submit">Отправить в ТУ/ДО</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <h1>{{ report.report }}</h1>
    <h2 id="report-status">Статус: {{ report.get_status_display }}</h2>
    {% if message == 'SendToTerAdmin' %}
        <div class="alert alert-success" role="alert" style="margin-top: 10px; text-align: center;">
            <div>Отчёт успешно отправлен на проверку в {{ school.ter_admin }}. Следите за изменением статус отчёта в Вашем личном кабинете.</div>
            <div>Если Вы нашли ошибку в отчёте, свяжитесь с ТУ/ДО и попросите их изменить Ваш отчёт.</div>
        </div>
    {% endif %}
    <div class="control-panel">
        <a href="{% url 'reports' school.id %}" style="width: 250px" class="btn btn-outline-primary" type="submit">Вернуться к отчётам</a>
        {% if report.status == 'C'%}
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#SaveModal">
                Отправить в ТУ/ДО
            </button>
        {% endif %}
    </div>
   {% for section in report.report.sections.all %}
        <div class="section {% if current_section == section.id %}current-section{% endif %} {% if forloop.first %}first{% elif forloop.last %}last{% endif %}">
            <h2>{{ section }}</h2>
            <table class="table section-table">
                <tr class="tr-section sticky-top">
                    <th>Показатели/критерии</th>
                    <th class="center th-points">Баллы</th>
                    <th class="center th-points">Макс.</th>
                </tr>
            {%for field in section.fields.all %}
                    <tr class="tr-field">
                        <th >{{ field }}</th>
                        <th colspan="2"></th>
                    </tr>
                    {%for question in field.questions.all %}
                        <tr class="question">
                            <td scope="row">
                                {% if question.answer_type == 'LST' %}
                                    <div class="form-floating mb-3 field">
                                        <select class="selectpicker" data-width="100%" data-live-search="true" id="{{ question.id }}" name="{{ question.id }}" placeholder="Не выбранно" {% if report.status != 'C'%}disabled{% endif%}>
                                            <option data-points="0" value="">—</option>
                                            {% for option in question.options.all %}
                                                <option value="{{ option.id }}"  data-points="{{option.points}}" {% if answers|find_answer:question == option.id %}selected{% endif %}>
                                                    {{ option.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <label for="{{ question.id }}">{{question.name}}</label>
                                    </div>
                                {% elif question.answer_type == 'NMBR' or question.answer_type == 'PRC' %}
                                    <div class="form-floating mb-3 field">
                                        <input type="number" class="form-control number-input" id="{{ question.id }}" data-points="{{ answers|get_points:question }}" value="{{answers|find_answer:question}}"  name="{{ question.id }}" placeholder="" {% if report.status != 'C'%}disabled{% endif%}>
                                        <label for="{{ question.id }}">{{question.name}}</label>
                                    </div>
                                {% elif question.answer_type == 'BL' %}
                                    <div class="form-check field">
                                        <input class="form-check-input" type="checkbox" data-points="{{question.bool_points}}" name="{{ question.id }}" id="{{ question.id }}" {% if answers|find_answer:question %}checked{% endif %} {% if report.status != 'C'%}disabled{% endif%}>
                                        <label class="form-check-label" for="{{ question.id }}">{{question.name}}</label>
                                    </div>
                                {% endif %}
                            </td>
                            <td scope="row" class="center question-points" id="points_{{ question.id }}">{{ answers|get_points:question }}</td>
                            <td scope="row" class="center question-points-max">{{ question|get_max_points }}</td>
                        </tr>
                    {% endfor %}
                {% endfor %}
                <tr class="tr-section">
                    <th>Всего</th>
                    <th class="center section-points"></th>
                    <th class="center section-points-max"></th>
                </tr>
            </table>
        </div>
   {% endfor %}
    <div class="sections-panel">
        <button style="width: 150px" id="btn-back" class="btn btn-outline-primary" type="submit">Назад</button>
        <button style="width: 150px" id="btn-forward" class="btn btn-primary" type="submit">Вперёд</button>
    </div>
{% endblock %}