# Экспорт Excel с графиками для школьных отчетов

## Описание функциональности

Добавлена возможность экспорта школьных отчетов в формат Excel с интерактивными графиками, показывающими динамику результатов по показателям. Графики размещаются непосредственно на соответствующих листах для удобства анализа.

## Что нового

### Основные изменения

1. **График на листе "Сводный отчет"** - основной график динамики по разделам
2. **Графики на листах разделов** - индивидуальные графики показателей для каждого раздела
3. **Идентичность веб-интерфейсу** - графики соответствуют тем, что отображаются на веб-странице
4. **Цветовая дифференциация по годам** - каждый год имеет свой цвет
5. **Обновленное имя файла** - содержит суффикс "_with_charts"

### Структура Excel файла

1. **Лист "Сводный отчет"**
   - Табличные данные по годам и разделам
   - **Основной график динамики** - показывает сравнение разделов по годам
   - Цветовое кодирование по зонам (красная/желтая/зеленая)

2. **Листы разделов** (по одному для каждого раздела)
   - Детализированные данные по показателям раздела
   - **График показателей раздела** - показывает динамику всех показателей раздела по годам
   - Разбивка по годам

## Типы графиков

### Основной график (лист "Сводный отчет")
- **Тип**: Столбчатая диаграмма
- **Данные**: Сравнение разделов между собой
- **Оси**: X - Разделы, Y - Баллы
- **Серии данных**: По годам (каждый год - отдельный цвет)
- **Размер**: 720x480 пикселей

### Графики разделов (листы разделов)
- **Тип**: Столбчатая диаграмма
- **Данные**: Сравнение показателей внутри раздела
- **Оси**: X - Показатели, Y - Баллы
- **Серии данных**: По годам (каждый год - отдельный цвет)
- **Размер**: 720x400 пикселей

## Как использовать

### Через веб-интерфейс

1. Перейдите на страницу школьного отчета: `http://127.0.0.1:8080/dashboards/ter_admins/school/`
2. Выберите школу и годы для анализа
3. Нажмите кнопку **"Скачать в Excel"**
4. Файл будет скачан с именем `school_report_{ID_школы}_{год}_with_charts.xlsx`

### Программно

```python
from dashboards.utils import generate_school_report_csv
from reports.models import *
from schools.models import *

# Получение данных
school = School.objects.get(id=296)  # ID школы
years = Year.objects.all()
s_reports = SchoolReport.objects.filter(school=school, status='D')
reports = Report.objects.filter(year__in=years, is_published=True)
sections = Section.objects.filter(report__in=reports).distinct('number').order_by('number')

# Генерация Excel с графиками
response = generate_school_report_csv(years.first(), school, s_reports, sections)

# Сохранение файла
with open('school_report_with_charts.xlsx', 'wb') as f:
    f.write(response.content)
```

## Технические детали

### Библиотеки

- **xlsxwriter** - для создания Excel файлов и графиков
- **Django** - для работы с моделями данных

### Цветовая схема (по годам)

- 2023: `#4dc9f6` (голубой)
- 2024: `#f67019` (оранжевый)
- 2025: `#f53794` (розовый)
- 2026: `#537bc4` (синий)
- 2027: `#acc236` (зеленый)
- Дополнительные: `#166a8f`, `#00a950`

### Структура данных

#### Основной график (лист "Сводный отчет")

| Год  | Раздел 1 | Раздел 2 | Раздел 3 | Раздел 4 | Раздел 5 |
|------|----------|----------|----------|----------|----------|
| 2023 | 71.5     | 71.0     | 71.0     | 71.0     | 71.0     |
| 2024 | 81.6     | 81.6     | 81.6     | 81.6     | 81.6     |

#### Графики разделов (листы разделов)

Для каждого раздела создается таблица показателей:

| Показатель | 2023 | 2024 |
|------------|------|------|
| 1.1        | 5.0  | 6.0  |
| 1.2        | 4.5  | 5.5  |
| 1.3        | 3.0  | 4.0  |

## Примеры использования

### Анализ динамики школы

1. Откройте Excel файл
2. На листе "Сводный отчет" посмотрите общую динамику по разделам
3. Перейдите на листы разделов для детального анализа показателей

### Сравнение разделов

- Основной график показывает, в каких разделах школа показывает лучшие/худшие результаты
- Сравните высоту столбцов для разных разделов в одном году
- Отследите изменения между годами

### Анализ показателей раздела

- На каждом листе раздела график показывает динамику всех показателей
- Выявите показатели с наибольшим ростом или снижением
- Используйте данные для планирования улучшений

## Соответствие веб-интерфейсу

Графики в Excel полностью соответствуют графикам на веб-странице:

1. **Основной график** идентичен графику "Динамика результатов школы по разделам"
2. **Графики разделов** идентичны графикам "Динамика результатов по показателям раздела X"
3. **Цветовая схема** соответствует веб-версии
4. **Структура данных** аналогична веб-отображению

## Устранение неполадок

### Файл не создается

1. Проверьте наличие данных для выбранной школы
2. Убедитесь, что есть отчеты со статусом "Принят" (D)
3. Проверьте наличие разделов и показателей в системе

### Графики не отображаются

1. Убедитесь, что используется Excel 2010 или новее
2. Проверьте, что включена поддержка макросов и объектов
3. Попробуйте открыть файл в другом Excel-совместимом приложении

### Ошибки при экспорте

1. Проверьте логи Django на наличие ошибок
2. Убедитесь, что установлена библиотека xlsxwriter
3. Проверьте права доступа к файловой системе

## Дополнительные возможности

### Настройка цветов

Цвета графиков можно изменить в файле `dashboards/utils.py`, функция `generate_school_report_csv`:

```python
# Массив цветов для годов
colors = ['#4dc9f6', '#f67019', '#f53794', '#537bc4', '#acc236', '#166a8f', '#00a950']
```

### Изменение размеров графиков

```python
# Основной график
main_chart.set_size({'width': 720, 'height': 480})

# Графики разделов
section_chart.set_size({'width': 720, 'height': 400})
```

### Добавление новых типов графиков

XlsxWriter поддерживает различные типы графиков:
- `'column'` - столбчатая диаграмма (используется)
- `'line'` - линейная диаграмма
- `'pie'` - круговая диаграмма
- `'bar'` - горизонтальная столбчатая диаграмма
- `'area'` - диаграмма с областями

## Преимущества новой структуры

1. **Логичное размещение**: Графики находятся рядом с соответствующими данными
2. **Удобство анализа**: Не нужно переключаться между листами для просмотра данных и графиков
3. **Соответствие веб-интерфейсу**: Пользователи видят знакомую структуру
4. **Экономия места**: Нет дублирования данных на отдельном листе

## Заключение

Обновленная функциональность экспорта Excel с графиками теперь полностью соответствует веб-интерфейсу и обеспечивает удобный анализ данных. Графики размещены на соответствующих листах, что делает работу с отчетами более интуитивной и эффективной. 