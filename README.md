# SchoolsRaitings
Веб система сбора данных для рейтингования школ Самарской области

## Функционал отложенного удаления отчетов

В системе реализован функционал отложенного удаления отчетов школ. Это позволяет:
1. Пометить отчеты на удаление, но оставить их в системе на определенный период
2. Автоматически удалить отчеты, когда истечет заданный срок

### Использование в административной панели

В административной панели для отчетов школ доступны следующие действия:
- **Пометить на удаление через 30 дней** - пометить выбранные отчеты на удаление через 30 дней
- **Пометить на удаление через 7 дней** - пометить выбранные отчеты на удаление через 7 дней
- **Пометить на удаление через 5 минут (ТЕСТ)** - пометить выбранные отчеты на удаление через 5 минут (для тестирования)
- **Снять пометку на удаление** - отменить запланированное удаление для выбранных отчетов

Также добавлен фильтр "Отмечен на удаление", позволяющий отобразить только отчеты, отмеченные на удаление, или те, которые не отмечены.

### Видимость отчетов, помеченных на удаление

Отчеты, помеченные на удаление, имеют следующие особенности:
- Видны только в административной панели, где ими можно управлять
- Не отображаются в пользовательском интерфейсе для школ, ТУ/ДО и других пользователей системы
- Не учитываются в статистике и отчетах (не влияют на количество школ в "красной", "желтой" и "зеленой" зонах)
- Не отображаются в выгрузках и экспортах данных

Это позволяет администраторам системы:
1. Видеть отчеты, помеченные на удаление, но еще не удаленные физически
2. При необходимости снять пометку на удаление и вернуть отчет в активное состояние
3. Контролировать процесс удаления до его фактического завершения

### Настройка автоматического удаления (cron)

Для фактического удаления отчетов, у которых истек срок, необходимо настроить выполнение команды управления Django по расписанию с помощью cron.

#### Автоматическая настройка (рекомендуется)

Используйте скрипт `setup_cron.sh` для автоматической настройки:

```bash
./setup_cron.sh
```

Скрипт автоматически:
- Определит путь к проекту и Python в виртуальном окружении
- Создаст директорию для логов
- Настроит cron задачу для запуска каждые 5 минут
- Предложит заменить существующую задачу, если она уже есть

Для автоматической замены существующей задачи без запроса подтверждения:
```bash
./setup_cron.sh --force
```

#### Ручная настройка

Если вы хотите настроить cron вручную:

1. Откройте файл crontab для редактирования:
```
crontab -e
```

2. Добавьте следующую строку для запуска команды каждые 5 минут:
```
*/5 * * * * cd /path/to/SchoolsRaitings && /path/to/python manage.py delete_expired_reports >> /path/to/SchoolsRaitings/logs/delete_reports.log 2>&1
```

Замените `/path/to/SchoolsRaitings` и `/path/to/python` на фактические пути к проекту и интерпретатору Python для вашего виртуального окружения.

### Инструменты для тестирования функционала

Для удобства тестирования и мониторинга функционала отложенного удаления в системе предусмотрены следующие инструменты:

#### Команда проверки отчетов, ожидающих удаления

```
python manage.py check_pending_deletion
```

Эта команда выводит информацию о всех отчетах, отмеченных на удаление, с указанием:
- ID отчета, название школы и отчета
- Запланированной даты и времени удаления
- Оставшегося времени до удаления в формате "часы:минуты:секунды"
- Пометки "ГОТОВ К УДАЛЕНИЮ" для отчетов, у которых срок уже истек

#### Команда тестирования пометки на удаление

```
python manage.py test_mark_deletion --minutes=5
```

Команда помечает первый активный отчет на удаление через указанное количество минут (по умолчанию 5) и показывает результаты тестирования видимости. Параметр `--minutes` можно изменить для установки другого интервала.

Для снятия пометки на удаление с отчета:

```
python manage.py test_mark_deletion --revert
```

#### Проверка работы команды удаления

```
python manage.py delete_expired_reports --dry-run
```

Эта команда выведет список отчетов, которые будут удалены, но не будет фактически их удалять.

## Регулирование ширины столбцов в административной панели

В системе реализован функционал для настройки ширины столбцов в административной панели:

### Возможности функционала

- Настройка фиксированной ширины столбцов (XS, SM, MD, LG, XL)
- Управление отображением длинного текста (обрезка с многоточием или перенос)
- Выравнивание содержимого (по левому краю, по центру, по правому краю)
- Интерактивное изменение настроек через контекстное меню
- Сохранение пользовательских настроек в браузере

### Использование

1. **В коде**: настройки по умолчанию задаются в `column_width_settings` класса ModelAdmin
2. **В интерфейсе**: нажмите правой кнопкой мыши на заголовок столбца для открытия меню настроек

Полная документация: [Функционал регулирования ширины столбцов](docs/column_width_feature.md)
