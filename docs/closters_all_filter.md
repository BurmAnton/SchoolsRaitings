# Фильтр "Все управления/департаменты" на странице кластеров

## Описание функциональности

На странице `/ter_admins/closters/` добавлена опция "Все управления/департаменты" в фильтр территориальных управлений для пользователей с расширенными правами.

## Доступ к функциональности

Опция "Все управления/департаменты" доступна только для:
- Администраторов (superuser)
- Пользователей с ролью "Представитель МинОбр"

## Поведение

1. **Для администраторов и представителей МинОбр:**
   - В выпадающем списке территориальных управлений появляется опция "Все управления/департаменты"
   - По умолчанию выбрана опция "Все управления/департаменты"
   - При выборе этой опции отображаются школы из всех территориальных управлений

2. **Для обычных пользователей:**
   - Опция "Все управления/департаменты" не отображается
   - Доступны только конкретные территориальные управления
   - По умолчанию выбрано "Центральное управление"

## Технические детали

### Изменения в шаблоне (`templates/dashboards/closters_report.html`)

```django
{% if is_mo_or_admin %}
    <option value="all" {% if not filter|get_item:"ter_admin" or filter|get_item:"ter_admin" == 'all' %}selected{% endif %}>
        Все управления/департаменты
    </option>
{% endif %}
```

### Изменения во view (`dashboards/views.py`)

1. Добавлена проверка роли пользователя:
```python
is_mo_or_admin = request.user.is_superuser or request.user.groups.filter(name='Представитель МинОбр').exists()
```

2. Обработка значения 'all' в фильтре:
```python
if ter_admin_f and ter_admin_f != 'all':
    schools = schools.filter(ter_admin=ter_admin_f)
    filter['ter_admin'] = ter_admin_f
elif ter_admin_f == 'all':
    filter['ter_admin'] = 'all'
```

3. Расширение списка школ для привилегированных пользователей:
```python
ter_admins_for_schools = ter_admins
if request.user.is_superuser or request.user.groups.filter(name='Представитель МинОбр').exists():
    ter_admins_for_schools = TerAdmin.objects.all()
```

## Оптимизации производительности

В процессе реализации были также внесены следующие оптимизации:

1. **Оптимизация запросов к БД:**
   - Добавлены `select_related` и `prefetch_related` для уменьшения количества запросов
   - Использование словарей для быстрого доступа к данным вместо повторных запросов

2. **Кэширование:**
   - Страница кэшируется на 5 минут с учетом параметров фильтрации
   - Ключ кэша включает все параметры фильтра для корректной инвалидации

## Проверка функциональности

Для проверки корректности работы:

1. Войдите как администратор или пользователь с ролью "Представитель МинОбр"
2. Перейдите на страницу `/ter_admins/closters/`
3. В фильтре "Территориальные управления/Департаменты образования" должна быть доступна опция "Все управления/департаменты"
4. При выборе этой опции должны отображаться школы из всех территориальных управлений 